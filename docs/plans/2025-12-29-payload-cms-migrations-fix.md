# Payload CMS Migrations Fix Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix Payload CMS build failure by creating migrations and consolidating all migrations into a unified `./migrations/` directory structure.

**Architecture:** Both Drizzle (app) and Payload (CMS) migrations will live under `./migrations/` with subdirectories `app/` and `cms/`. The build script continues to run both migration systems sequentially before Next.js build. Error handling is added to gracefully fallback when CMS tables don't exist.

**Tech Stack:** Drizzle Kit 0.31.8, Payload CMS 3.69.0, PostgreSQL, Next.js 16

---

## Task 1: Create New Migrations Directory Structure

**Files:**

- Create: `migrations/app/` (move from `drizzle/`)
- Create: `migrations/cms/`

**Step 1: Create the new directory structure**

```bash
mkdir -p migrations/app migrations/cms
```

**Step 2: Move existing Drizzle migrations**

```bash
cp -r drizzle/* migrations/app/
```

**Step 3: Verify the move**

Run: `ls -la migrations/app/`
Expected: Shows all 23 SQL files (0000-0022) and `meta/` directory

**Step 4: Remove old drizzle directory**

```bash
rm -rf drizzle
```

**Step 5: Commit**

```bash
git add -A
git commit -m "chore: move Drizzle migrations to migrations/app/"
```

---

## Task 2: Update Drizzle Configuration

**Files:**

- Modify: `drizzle.config.ts:14`

**Step 1: Update the out directory**

Change:

```typescript
out: "./drizzle",
```

To:

```typescript
out: "./migrations/app",
```

**Step 2: Verify Drizzle recognizes the migrations**

Run: `pnpm drizzle-kit check`
Expected: No errors, recognizes existing migrations

**Step 3: Commit**

```bash
git add drizzle.config.ts
git commit -m "chore: update Drizzle config to use migrations/app/"
```

---

## Task 3: Update Payload Configuration

**Files:**

- Modify: `src/payload.config.ts:28-32`

**Step 1: Add migrationDir to postgresAdapter**

Update the db configuration:

```typescript
db: postgresAdapter({
  pool: {
    connectionString: process.env.DATABASE_URL_PAYLOAD || "",
  },
  migrationDir: path.resolve(dirname, "../migrations/cms"),
}),
```

**Step 2: Verify TypeScript compiles**

Run: `pnpm typecheck`
Expected: No errors related to payload.config.ts

**Step 3: Commit**

```bash
git add src/payload.config.ts
git commit -m "chore: configure Payload CMS migration directory"
```

---

## Task 4: Generate Initial Payload Migration

**Files:**

- Create: `migrations/cms/*.ts` (generated by Payload)
- Create: `migrations/cms/index.ts` (generated by Payload)

**Step 1: Ensure Payload database is running**

Run: `docker compose up -d db-payload`

**Step 2: Generate the initial migration**

Run: `pnpm payload migrate:create`
Expected: Creates migration file in `migrations/cms/` with timestamp name

**Step 3: Verify migration was created**

Run: `ls -la migrations/cms/`
Expected: Shows at least one `.ts` migration file and `index.ts`

**Step 4: Run the migration locally**

Run: `pnpm payload migrate`
Expected: Migration runs successfully, creates tables (users, media, pages, etc.)

**Step 5: Commit the generated migrations**

```bash
git add migrations/cms/
git commit -m "feat: add initial Payload CMS migrations"
```

---

## Task 5: Generate Payload Types and ImportMap

**Files:**

- Regenerate: `src/payload/payload-types.ts`
- Regenerate: `src/app/(payload)/admin/importMap.js`

**Reference:** [Payload CMS Configuration Docs](https://payloadcms.com/docs/configuration/overview)

**Step 1: Generate TypeScript types**

Run: `pnpm payload generate:types`
Expected: Updates `src/payload/payload-types.ts` with types for all collections (Users, Media, Pages)

**Step 2: Verify types were generated**

Run: `cat src/payload/payload-types.ts | head -50`
Expected: Shows generated interfaces for Page, Media, User collections

**Step 3: Generate import map**

Run: `pnpm payload generate:importmap`
Expected: Updates `src/app/(payload)/admin/importMap.js` with component imports

**Step 4: Verify TypeScript compiles with new types**

Run: `pnpm typecheck`
Expected: No errors

**Step 5: Commit generated files**

```bash
git add src/payload/payload-types.ts src/app/\(payload\)/admin/importMap.js
git commit -m "chore: regenerate Payload types and importMap"
```

---

## Task 6: Test Seed API Endpoint

**Files:**

- Existing: `src/app/api/admin/seed/route.ts`
- Existing: `src/app/api/admin/seed/seeders/homepage.ts`

**Prerequisites:**

- `ADMIN_SEED_TOKEN` environment variable must be set in `.env.local`
- Payload database running with migrations applied

**Step 1: Ensure ADMIN_SEED_TOKEN is configured**

Check `.env.local` has:

```
ADMIN_SEED_TOKEN=<your-secure-token>
```

If not set, generate one:

```bash
echo "ADMIN_SEED_TOKEN=$(openssl rand -hex 32)" >> .env.local
```

**Step 2: Start the development server**

Run: `pnpm dev`
Expected: Server starts on http://localhost:3000

**Step 3: Test listing available seeders**

Run:

```bash
curl -X GET http://localhost:3000/api/admin/seed \
  -H "Authorization: Bearer $(grep ADMIN_SEED_TOKEN .env.local | cut -d= -f2)"
```

Expected: `{"seeders":["homepage"],"usage":"POST /api/admin/seed?seeder=<name>"}`

**Step 4: Run the homepage seeder**

Run:

```bash
curl -X POST "http://localhost:3000/api/admin/seed?seeder=homepage" \
  -H "Authorization: Bearer $(grep ADMIN_SEED_TOKEN .env.local | cut -d= -f2)"
```

Expected: `{"success":true,"message":"Homepage seeded successfully with nl and en content","data":{"pageId":"..."}}`

Or if already seeded: `{"success":true,"message":"Homepage already exists, skipping seed","data":{"skipped":true,"existingId":"..."}}`

**Step 5: Verify homepage in Payload admin**

Open: http://localhost:3000/admin/collections/pages
Expected: See "Kynite" page with slug "home", both nl and en locales have content

**Step 6: Verify homepage renders from CMS**

Open: http://localhost:3000
Expected: Homepage shows CMS content (hero, features, pricing, CTA sections)

---

## Task 7: Fix generateStaticParams Error Handling

**Files:**

- Modify: `src/app/(main)/[locale]/[slug]/page.tsx:12-18`

**Step 1: Add error handling to generateStaticParams**

Update the function:

```typescript
export async function generateStaticParams() {
  try {
    const slugs = await getAllPageSlugs();
    return routing.locales.flatMap((locale) =>
      slugs.map((slug) => ({ locale, slug }))
    );
  } catch {
    // Tables may not exist during initial build or if CMS is not configured
    return [];
  }
}
```

**Step 2: Verify TypeScript compiles**

Run: `pnpm typecheck`
Expected: No errors

**Step 3: Commit**

```bash
git add src/app/\(main\)/\[locale\]/\[slug\]/page.tsx
git commit -m "fix: handle missing Payload tables in generateStaticParams"
```

---

## Task 8: Update Homepage to Handle Missing CMS

**Files:**

- Modify: `src/app/(main)/[locale]/page.tsx:12-33`

**Step 1: Add error handling to homepage**

The homepage already has a `HomeContent` fallback. Wrap `getHomepage` in try-catch:

```typescript
export default async function Home({ params }: Props) {
  const { locale } = await params;
  setRequestLocale(locale as Locale);

  let page = null;
  try {
    page = await getHomepage(locale as "nl" | "en");
  } catch {
    // CMS tables may not exist yet - fall through to HomeContent
  }

  // If CMS content is available, render it with BlockRenderer
  if (page?.layout && page.layout.length > 0) {
    return (
      <div className="flex min-h-screen flex-col">
        <HomepageHeader />
        <main className="flex-1">
          <BlockRenderer blocks={page.layout as BlockData[]} />
        </main>
        <HomepageFooter />
      </div>
    );
  }

  // Fallback to static content if no CMS content is configured
  return <HomeContent />;
}
```

**Step 2: Verify TypeScript compiles**

Run: `pnpm typecheck`
Expected: No errors

**Step 3: Commit**

```bash
git add src/app/\(main\)/\[locale\]/page.tsx
git commit -m "fix: handle missing Payload CMS gracefully on homepage"
```

---

## Task 9: Verify Local Build

**Step 1: Run full build locally**

Run: `pnpm build`
Expected: Build completes successfully with:

- Drizzle migrations applied from `migrations/app/`
- Payload migrations applied from `migrations/cms/`
- Next.js build succeeds

**Step 2: Test the application**

Run: `pnpm dev`

- Navigate to `http://localhost:3000` - Homepage should load
- Navigate to `http://localhost:3000/admin` - Payload admin should work

---

## Task 10: Final Commit and Push

**Step 1: Create final commit if any uncommitted changes remain**

```bash
git status
# If changes exist:
git add -A
git commit -m "chore: finalize Payload CMS migration setup"
```

**Step 2: Push to trigger Vercel deployment**

```bash
git push origin main
```

**Step 3: Monitor Vercel build**

Expected: Build should complete successfully with all migrations running.

---

## Summary of Changes

| File                                      | Change                                      |
| ----------------------------------------- | ------------------------------------------- |
| `drizzle.config.ts`                       | Update `out` to `./migrations/app`          |
| `src/payload.config.ts`                   | Add `migrationDir` option                   |
| `migrations/app/*`                        | Moved from `drizzle/*`                      |
| `migrations/cms/*`                        | Generated by `payload migrate:create`       |
| `src/payload/payload-types.ts`            | Regenerated by `payload generate:types`     |
| `src/app/(payload)/admin/importMap.js`    | Regenerated by `payload generate:importmap` |
| `src/app/(main)/[locale]/[slug]/page.tsx` | Add try-catch to `generateStaticParams`     |
| `src/app/(main)/[locale]/page.tsx`        | Add try-catch to `getHomepage`              |

## Environment Variables Required on Vercel

Ensure these are set:

- `DATABASE_URL` - Main app database (Drizzle)
- `DATABASE_URL_PAYLOAD` - Payload CMS database
- `PAYLOAD_SECRET` - Payload secret key
- `ADMIN_SEED_TOKEN` - Token for seed API endpoint (for seeding homepage content)
